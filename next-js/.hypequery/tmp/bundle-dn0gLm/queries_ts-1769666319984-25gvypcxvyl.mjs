// analytics/queries.ts
import { formatDateTime } from "@hypequery/clickhouse";
import { initServe } from "@hypequery/serve";
import { z } from "zod";

// analytics/client.ts
import { createQueryBuilder } from "@hypequery/clickhouse";
var db = createQueryBuilder({
  url: process.env.CLICKHOUSE_HOST,
  username: process.env.CLICKHOUSE_USERNAME,
  password: process.env.CLICKHOUSE_PASSWORD,
  database: process.env.CLICKHOUSE_DATABASE
});

// analytics/queries.ts
var { define, queries, query } = initServe({
  context: () => ({ db })
});
var api = define({
  basePath: "/api/analytics",
  queries: queries({
    dailyStats: query.describe("Daily trip counts and revenue").input(
      z.object({
        startDate: z.string().datetime(),
        endDate: z.string().datetime()
      })
    ).output(
      z.array(
        z.object({
          day: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_fare: z.number(),
          avg_distance: z.number()
        })
      )
    ).query(
      ({ ctx, input }) => {
        const res = ctx.db.table("trips").where("pickup_datetime", "gte", input.startDate).where("pickup_datetime", "lte", input.endDate).select([formatDateTime("pickup_datetime", "%Y-%m-%d", { alias: "day" })]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("fare_amount", "avg_fare").avg("trip_distance", "avg_distance").orderBy("day", "ASC").groupByTimeInterval("pickup_datetime", "1 day").toSQL();
        console.log(res);
      }
    ),
    topPickupLocations: query.describe("Top neighborhoods by trip volume").input(
      z.object({
        limit: z.number().min(1).max(50).default(10)
      })
    ).output(
      z.array(
        z.object({
          neighborhood: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_fare: z.number()
        })
      )
    ).query(({ ctx, input }) => {
      const limit = input.limit ?? 10;
      return ctx.db.table("trips").select(["pickup_ntaname AS neighborhood"]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("fare_amount", "avg_fare").groupBy(["neighborhood"]).orderBy("trip_count", "DESC").limit(limit).execute();
    }),
    revenueByPayment: query.describe("Revenue breakdown by payment method").output(
      z.array(
        z.object({
          payment_type: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_tip: z.number()
        })
      )
    ).query(
      ({ ctx }) => ctx.db.table("trips").select(["payment_type"]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("tip_amount", "avg_tip").groupBy(["payment_type"]).orderBy("total_revenue", "DESC").execute()
    )
  })
});
api.route("/dailyStats", api.queries.dailyStats, { method: "POST" });
api.route("/topPickupLocations", api.queries.topPickupLocations, { method: "POST" });
api.route("/revenueByPayment", api.queries.revenueByPayment, { method: "GET" });
export {
  api
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiYW5hbHl0aWNzL3F1ZXJpZXMudHMiLCAiYW5hbHl0aWNzL2NsaWVudC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgZm9ybWF0RGF0ZVRpbWUgfSBmcm9tICdAaHlwZXF1ZXJ5L2NsaWNraG91c2UnO1xuaW1wb3J0IHsgaW5pdFNlcnZlIH0gZnJvbSAnQGh5cGVxdWVyeS9zZXJ2ZSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IGRiIH0gZnJvbSAnLi9jbGllbnQnO1xuXG5jb25zdCB7IGRlZmluZSwgcXVlcmllcywgcXVlcnkgfSA9IGluaXRTZXJ2ZSh7XG4gIGNvbnRleHQ6ICgpID0+ICh7IGRiIH0pLFxufSk7XG5cbmV4cG9ydCBjb25zdCBhcGkgPSBkZWZpbmUoe1xuICBiYXNlUGF0aDogJy9hcGkvYW5hbHl0aWNzJyxcbiAgcXVlcmllczogcXVlcmllcyh7XG4gICAgZGFpbHlTdGF0czogcXVlcnlcbiAgICAgIC5kZXNjcmliZSgnRGFpbHkgdHJpcCBjb3VudHMgYW5kIHJldmVudWUnKVxuICAgICAgLmlucHV0KFxuICAgICAgICB6Lm9iamVjdCh7XG4gICAgICAgICAgc3RhcnREYXRlOiB6LnN0cmluZygpLmRhdGV0aW1lKCksXG4gICAgICAgICAgZW5kRGF0ZTogei5zdHJpbmcoKS5kYXRldGltZSgpLFxuICAgICAgICB9KSxcbiAgICAgIClcbiAgICAgIC5vdXRwdXQoXG4gICAgICAgIHouYXJyYXkoXG4gICAgICAgICAgei5vYmplY3Qoe1xuICAgICAgICAgICAgZGF5OiB6LnN0cmluZygpLFxuICAgICAgICAgICAgdHJpcF9jb3VudDogei5udW1iZXIoKSxcbiAgICAgICAgICAgIHRvdGFsX3JldmVudWU6IHoubnVtYmVyKCksXG4gICAgICAgICAgICBhdmdfZmFyZTogei5udW1iZXIoKSxcbiAgICAgICAgICAgIGF2Z19kaXN0YW5jZTogei5udW1iZXIoKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICAgIC5xdWVyeSgoeyBjdHgsIGlucHV0IH0pID0+IHtcbiAgICAgICAgY29uc3QgcmVzID0gY3R4LmRiXG4gICAgICAgICAgLnRhYmxlKCd0cmlwcycpXG4gICAgICAgICAgLndoZXJlKCdwaWNrdXBfZGF0ZXRpbWUnLCAnZ3RlJywgaW5wdXQuc3RhcnREYXRlKVxuICAgICAgICAgIC53aGVyZSgncGlja3VwX2RhdGV0aW1lJywgJ2x0ZScsIGlucHV0LmVuZERhdGUpXG4gICAgICAgICAgLnNlbGVjdChbZm9ybWF0RGF0ZVRpbWUoJ3BpY2t1cF9kYXRldGltZScsICclWS0lbS0lZCcsIHsgYWxpYXM6ICdkYXknIH0pXSlcbiAgICAgICAgICAuY291bnQoJ3RyaXBfaWQnLCAndHJpcF9jb3VudCcpXG4gICAgICAgICAgLnN1bSgndG90YWxfYW1vdW50JywgJ3RvdGFsX3JldmVudWUnKVxuICAgICAgICAgIC5hdmcoJ2ZhcmVfYW1vdW50JywgJ2F2Z19mYXJlJylcbiAgICAgICAgICAuYXZnKCd0cmlwX2Rpc3RhbmNlJywgJ2F2Z19kaXN0YW5jZScpXG4gICAgICAgICAgLm9yZGVyQnkoJ2RheScsICdBU0MnKVxuICAgICAgICAgIC5ncm91cEJ5VGltZUludGVydmFsKCdwaWNrdXBfZGF0ZXRpbWUnLCAnMSBkYXknKVxuICAgICAgICAgIC50b1NRTCgpXG5cbiAgICAgICAgY29uc29sZS5sb2cocmVzKVxuICAgICAgfVxuICAgICAgKSxcblxuICAgIHRvcFBpY2t1cExvY2F0aW9uczogcXVlcnlcbiAgICAgIC5kZXNjcmliZSgnVG9wIG5laWdoYm9yaG9vZHMgYnkgdHJpcCB2b2x1bWUnKVxuICAgICAgLmlucHV0KFxuICAgICAgICB6Lm9iamVjdCh7XG4gICAgICAgICAgbGltaXQ6IHoubnVtYmVyKCkubWluKDEpLm1heCg1MCkuZGVmYXVsdCgxMCksXG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgICAgLm91dHB1dChcbiAgICAgICAgei5hcnJheShcbiAgICAgICAgICB6Lm9iamVjdCh7XG4gICAgICAgICAgICBuZWlnaGJvcmhvb2Q6IHouc3RyaW5nKCksXG4gICAgICAgICAgICB0cmlwX2NvdW50OiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgdG90YWxfcmV2ZW51ZTogei5udW1iZXIoKSxcbiAgICAgICAgICAgIGF2Z19mYXJlOiB6Lm51bWJlcigpLFxuICAgICAgICAgIH0pLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICAgLnF1ZXJ5KCh7IGN0eCwgaW5wdXQgfSkgPT4ge1xuICAgICAgICBjb25zdCBsaW1pdCA9IGlucHV0LmxpbWl0ID8/IDEwO1xuXG4gICAgICAgIHJldHVybiBjdHguZGJcbiAgICAgICAgICAudGFibGUoJ3RyaXBzJylcbiAgICAgICAgICAuc2VsZWN0KFsncGlja3VwX250YW5hbWUgQVMgbmVpZ2hib3Job29kJ10pXG4gICAgICAgICAgLmNvdW50KCd0cmlwX2lkJywgJ3RyaXBfY291bnQnKVxuICAgICAgICAgIC5zdW0oJ3RvdGFsX2Ftb3VudCcsICd0b3RhbF9yZXZlbnVlJylcbiAgICAgICAgICAuYXZnKCdmYXJlX2Ftb3VudCcsICdhdmdfZmFyZScpXG4gICAgICAgICAgLmdyb3VwQnkoWyduZWlnaGJvcmhvb2QnXSlcbiAgICAgICAgICAub3JkZXJCeSgndHJpcF9jb3VudCcsICdERVNDJylcbiAgICAgICAgICAubGltaXQobGltaXQpXG4gICAgICAgICAgLmV4ZWN1dGUoKTtcbiAgICAgIH0pLFxuXG4gICAgcmV2ZW51ZUJ5UGF5bWVudDogcXVlcnlcbiAgICAgIC5kZXNjcmliZSgnUmV2ZW51ZSBicmVha2Rvd24gYnkgcGF5bWVudCBtZXRob2QnKVxuICAgICAgLm91dHB1dChcbiAgICAgICAgei5hcnJheShcbiAgICAgICAgICB6Lm9iamVjdCh7XG4gICAgICAgICAgICBwYXltZW50X3R5cGU6IHouc3RyaW5nKCksXG4gICAgICAgICAgICB0cmlwX2NvdW50OiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgdG90YWxfcmV2ZW51ZTogei5udW1iZXIoKSxcbiAgICAgICAgICAgIGF2Z190aXA6IHoubnVtYmVyKCksXG4gICAgICAgICAgfSksXG4gICAgICAgICksXG4gICAgICApXG4gICAgICAucXVlcnkoKHsgY3R4IH0pID0+XG4gICAgICAgIGN0eC5kYlxuICAgICAgICAgIC50YWJsZSgndHJpcHMnKVxuICAgICAgICAgIC5zZWxlY3QoWydwYXltZW50X3R5cGUnXSlcbiAgICAgICAgICAuY291bnQoJ3RyaXBfaWQnLCAndHJpcF9jb3VudCcpXG4gICAgICAgICAgLnN1bSgndG90YWxfYW1vdW50JywgJ3RvdGFsX3JldmVudWUnKVxuICAgICAgICAgIC5hdmcoJ3RpcF9hbW91bnQnLCAnYXZnX3RpcCcpXG4gICAgICAgICAgLmdyb3VwQnkoWydwYXltZW50X3R5cGUnXSlcbiAgICAgICAgICAub3JkZXJCeSgndG90YWxfcmV2ZW51ZScsICdERVNDJylcbiAgICAgICAgICAuZXhlY3V0ZSgpLFxuICAgICAgKSxcbiAgfSksXG59KTtcblxuYXBpLnJvdXRlKCcvZGFpbHlTdGF0cycsIGFwaS5xdWVyaWVzLmRhaWx5U3RhdHMsIHsgbWV0aG9kOiAnUE9TVCcgfSk7XG5hcGkucm91dGUoJy90b3BQaWNrdXBMb2NhdGlvbnMnLCBhcGkucXVlcmllcy50b3BQaWNrdXBMb2NhdGlvbnMsIHsgbWV0aG9kOiAnUE9TVCcgfSk7XG5hcGkucm91dGUoJy9yZXZlbnVlQnlQYXltZW50JywgYXBpLnF1ZXJpZXMucmV2ZW51ZUJ5UGF5bWVudCwgeyBtZXRob2Q6ICdHRVQnIH0pO1xuIiwgImltcG9ydCB7IGNyZWF0ZVF1ZXJ5QnVpbGRlciB9IGZyb20gJ0BoeXBlcXVlcnkvY2xpY2tob3VzZSc7XG5pbXBvcnQgdHlwZSB7IEludHJvc3BlY3RlZFNjaGVtYSB9IGZyb20gJy4vc2NoZW1hJztcblxuZXhwb3J0IGNvbnN0IGRiID0gY3JlYXRlUXVlcnlCdWlsZGVyPEludHJvc3BlY3RlZFNjaGVtYT4oe1xuICB1cmw6IHByb2Nlc3MuZW52LkNMSUNLSE9VU0VfSE9TVCEsXG4gIHVzZXJuYW1lOiBwcm9jZXNzLmVudi5DTElDS0hPVVNFX1VTRVJOQU1FLFxuICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuQ0xJQ0tIT1VTRV9QQVNTV09SRCxcbiAgZGF0YWJhc2U6IHByb2Nlc3MuZW52LkNMSUNLSE9VU0VfREFUQUJBU0UhLFxufSk7XG5cbiJdLAogICJtYXBwaW5ncyI6ICI7QUFBQSxTQUFTLHNCQUFzQjtBQUMvQixTQUFTLGlCQUFpQjtBQUMxQixTQUFTLFNBQVM7OztBQ0ZsQixTQUFTLDBCQUEwQjtBQUc1QixJQUFNLEtBQUssbUJBQXVDO0FBQUEsRUFDdkQsS0FBSyxRQUFRLElBQUk7QUFBQSxFQUNqQixVQUFVLFFBQVEsSUFBSTtBQUFBLEVBQ3RCLFVBQVUsUUFBUSxJQUFJO0FBQUEsRUFDdEIsVUFBVSxRQUFRLElBQUk7QUFDeEIsQ0FBQzs7O0FESEQsSUFBTSxFQUFFLFFBQVEsU0FBUyxNQUFNLElBQUksVUFBVTtBQUFBLEVBQzNDLFNBQVMsT0FBTyxFQUFFLEdBQUc7QUFDdkIsQ0FBQztBQUVNLElBQU0sTUFBTSxPQUFPO0FBQUEsRUFDeEIsVUFBVTtBQUFBLEVBQ1YsU0FBUyxRQUFRO0FBQUEsSUFDZixZQUFZLE1BQ1QsU0FBUywrQkFBK0IsRUFDeEM7QUFBQSxNQUNDLEVBQUUsT0FBTztBQUFBLFFBQ1AsV0FBVyxFQUFFLE9BQU8sRUFBRSxTQUFTO0FBQUEsUUFDL0IsU0FBUyxFQUFFLE9BQU8sRUFBRSxTQUFTO0FBQUEsTUFDL0IsQ0FBQztBQUFBLElBQ0gsRUFDQztBQUFBLE1BQ0MsRUFBRTtBQUFBLFFBQ0EsRUFBRSxPQUFPO0FBQUEsVUFDUCxLQUFLLEVBQUUsT0FBTztBQUFBLFVBQ2QsWUFBWSxFQUFFLE9BQU87QUFBQSxVQUNyQixlQUFlLEVBQUUsT0FBTztBQUFBLFVBQ3hCLFVBQVUsRUFBRSxPQUFPO0FBQUEsVUFDbkIsY0FBYyxFQUFFLE9BQU87QUFBQSxRQUN6QixDQUFDO0FBQUEsTUFDSDtBQUFBLElBQ0YsRUFD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

//# sourceURL=file:///Users/lukereilly/repos/hypequery-examples/next-js/analytics/queries.ts