// analytics/queries.ts
import { formatDateTime } from "@hypequery/clickhouse";
import { initServe } from "@hypequery/serve";
import { z } from "zod";

// analytics/client.ts
import { createQueryBuilder } from "@hypequery/clickhouse";
var db = createQueryBuilder({
  url: process.env.CLICKHOUSE_URL ?? process.env.CLICKHOUSE_HOST,
  username: "default",
  password: process.env.CLICKHOUSE_PASSWORD,
  database: process.env.CLICKHOUSE_DATABASE
});
var client_default = db;

// analytics/queries.ts
var { define, queries, query } = initServe({
  context: () => ({ db: client_default })
});
var api = define({
  basePath: "/api/analytics",
  queries: queries({
    dailyStats: query.describe("Daily trip counts and revenue").input(
      z.object({
        startDate: z.string().datetime(),
        endDate: z.string().datetime()
      })
    ).output(
      z.array(
        z.object({
          day: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_fare: z.number(),
          avg_distance: z.number()
        })
      )
    ).query(
      ({ ctx, input }) => ctx.db.table("trips").where("pickup_datetime", "gte", input.startDate).where("pickup_datetime", "lte", input.endDate).groupByTimeInterval("pickup_datetime", "1 day").select([formatDateTime("pickup_datetime", "%Y-%m-%d", { alias: "day" })]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("fare_amount", "avg_fare").avg("trip_distance", "avg_distance").orderBy("day", "ASC").execute()
    ),
    topPickupLocations: query.describe("Top neighborhoods by trip volume").input(
      z.object({
        limit: z.number().min(1).max(50).default(10)
      })
    ).output(
      z.array(
        z.object({
          neighborhood: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_fare: z.number()
        })
      )
    ).query(({ ctx, input }) => {
      const limit = input.limit ?? 10;
      return ctx.db.table("trips").select(["pickup_ntaname AS neighborhood"]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("fare_amount", "avg_fare").groupBy(["neighborhood"]).orderBy("trip_count", "DESC").limit(limit).execute();
    }),
    revenueByPayment: query.describe("Revenue breakdown by payment method").output(
      z.array(
        z.object({
          payment_type: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_tip: z.number()
        })
      )
    ).query(
      ({ ctx }) => ctx.db.table("trips").select(["payment_type"]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("tip_amount", "avg_tip").groupBy(["payment_type"]).orderBy("total_revenue", "DESC").execute()
    )
  })
});
api.route("/dailyStats", api.queries.dailyStats, { method: "POST" });
api.route("/topPickupLocations", api.queries.topPickupLocations, { method: "POST" });
api.route("/revenueByPayment", api.queries.revenueByPayment, { method: "GET" });
export {
  api
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiYW5hbHl0aWNzL3F1ZXJpZXMudHMiLCAiYW5hbHl0aWNzL2NsaWVudC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgZm9ybWF0RGF0ZVRpbWUgfSBmcm9tICdAaHlwZXF1ZXJ5L2NsaWNraG91c2UnO1xuaW1wb3J0IHsgaW5pdFNlcnZlIH0gZnJvbSAnQGh5cGVxdWVyeS9zZXJ2ZSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCBkYiBmcm9tICcuL2NsaWVudCc7XG5cbmNvbnN0IHsgZGVmaW5lLCBxdWVyaWVzLCBxdWVyeSB9ID0gaW5pdFNlcnZlKHtcbiAgY29udGV4dDogKCkgPT4gKHsgZGIgfSksXG59KTtcblxuZXhwb3J0IGNvbnN0IGFwaSA9IGRlZmluZSh7XG4gIGJhc2VQYXRoOiAnL2FwaS9hbmFseXRpY3MnLFxuICBxdWVyaWVzOiBxdWVyaWVzKHtcbiAgICBkYWlseVN0YXRzOiBxdWVyeVxuICAgICAgLmRlc2NyaWJlKCdEYWlseSB0cmlwIGNvdW50cyBhbmQgcmV2ZW51ZScpXG4gICAgICAuaW5wdXQoXG4gICAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgICBzdGFydERhdGU6IHouc3RyaW5nKCkuZGF0ZXRpbWUoKSxcbiAgICAgICAgICBlbmREYXRlOiB6LnN0cmluZygpLmRhdGV0aW1lKCksXG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgICAgLm91dHB1dChcbiAgICAgICAgei5hcnJheShcbiAgICAgICAgICB6Lm9iamVjdCh7XG4gICAgICAgICAgICBkYXk6IHouc3RyaW5nKCksXG4gICAgICAgICAgICB0cmlwX2NvdW50OiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgdG90YWxfcmV2ZW51ZTogei5udW1iZXIoKSxcbiAgICAgICAgICAgIGF2Z19mYXJlOiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgYXZnX2Rpc3RhbmNlOiB6Lm51bWJlcigpLFxuICAgICAgICAgIH0pLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICAgLnF1ZXJ5KCh7IGN0eCwgaW5wdXQgfSkgPT5cbiAgICAgICAgY3R4LmRiXG4gICAgICAgICAgLnRhYmxlKCd0cmlwcycpXG4gICAgICAgICAgLndoZXJlKCdwaWNrdXBfZGF0ZXRpbWUnLCAnZ3RlJywgaW5wdXQuc3RhcnREYXRlKVxuICAgICAgICAgIC53aGVyZSgncGlja3VwX2RhdGV0aW1lJywgJ2x0ZScsIGlucHV0LmVuZERhdGUpXG4gICAgICAgICAgLmdyb3VwQnlUaW1lSW50ZXJ2YWwoJ3BpY2t1cF9kYXRldGltZScsICcxIGRheScpXG4gICAgICAgICAgLnNlbGVjdChbZm9ybWF0RGF0ZVRpbWUoJ3BpY2t1cF9kYXRldGltZScsICclWS0lbS0lZCcsIHsgYWxpYXM6ICdkYXknIH0pXSlcbiAgICAgICAgICAuY291bnQoJ3RyaXBfaWQnLCAndHJpcF9jb3VudCcpXG4gICAgICAgICAgLnN1bSgndG90YWxfYW1vdW50JywgJ3RvdGFsX3JldmVudWUnKVxuICAgICAgICAgIC5hdmcoJ2ZhcmVfYW1vdW50JywgJ2F2Z19mYXJlJylcbiAgICAgICAgICAuYXZnKCd0cmlwX2Rpc3RhbmNlJywgJ2F2Z19kaXN0YW5jZScpXG4gICAgICAgICAgLm9yZGVyQnkoJ2RheScsICdBU0MnKVxuICAgICAgICAgIC5leGVjdXRlKCksXG4gICAgICApLFxuXG4gICAgdG9wUGlja3VwTG9jYXRpb25zOiBxdWVyeVxuICAgICAgLmRlc2NyaWJlKCdUb3AgbmVpZ2hib3Job29kcyBieSB0cmlwIHZvbHVtZScpXG4gICAgICAuaW5wdXQoXG4gICAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgICBsaW1pdDogei5udW1iZXIoKS5taW4oMSkubWF4KDUwKS5kZWZhdWx0KDEwKSxcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICAub3V0cHV0KFxuICAgICAgICB6LmFycmF5KFxuICAgICAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgICAgIG5laWdoYm9yaG9vZDogei5zdHJpbmcoKSxcbiAgICAgICAgICAgIHRyaXBfY291bnQ6IHoubnVtYmVyKCksXG4gICAgICAgICAgICB0b3RhbF9yZXZlbnVlOiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgYXZnX2ZhcmU6IHoubnVtYmVyKCksXG4gICAgICAgICAgfSksXG4gICAgICAgICksXG4gICAgICApXG4gICAgICAucXVlcnkoKHsgY3R4LCBpbnB1dCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IGxpbWl0ID0gaW5wdXQubGltaXQgPz8gMTA7XG5cbiAgICAgICAgcmV0dXJuIGN0eC5kYlxuICAgICAgICAgIC50YWJsZSgndHJpcHMnKVxuICAgICAgICAgIC5zZWxlY3QoWydwaWNrdXBfbnRhbmFtZSBBUyBuZWlnaGJvcmhvb2QnXSlcbiAgICAgICAgICAuY291bnQoJ3RyaXBfaWQnLCAndHJpcF9jb3VudCcpXG4gICAgICAgICAgLnN1bSgndG90YWxfYW1vdW50JywgJ3RvdGFsX3JldmVudWUnKVxuICAgICAgICAgIC5hdmcoJ2ZhcmVfYW1vdW50JywgJ2F2Z19mYXJlJylcbiAgICAgICAgICAuZ3JvdXBCeShbJ25laWdoYm9yaG9vZCddKVxuICAgICAgICAgIC5vcmRlckJ5KCd0cmlwX2NvdW50JywgJ0RFU0MnKVxuICAgICAgICAgIC5saW1pdChsaW1pdClcbiAgICAgICAgICAuZXhlY3V0ZSgpO1xuICAgICAgfSksXG5cbiAgICByZXZlbnVlQnlQYXltZW50OiBxdWVyeVxuICAgICAgLmRlc2NyaWJlKCdSZXZlbnVlIGJyZWFrZG93biBieSBwYXltZW50IG1ldGhvZCcpXG4gICAgICAub3V0cHV0KFxuICAgICAgICB6LmFycmF5KFxuICAgICAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgICAgIHBheW1lbnRfdHlwZTogei5zdHJpbmcoKSxcbiAgICAgICAgICAgIHRyaXBfY291bnQ6IHoubnVtYmVyKCksXG4gICAgICAgICAgICB0b3RhbF9yZXZlbnVlOiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgYXZnX3RpcDogei5udW1iZXIoKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICAgIC5xdWVyeSgoeyBjdHggfSkgPT5cbiAgICAgICAgY3R4LmRiXG4gICAgICAgICAgLnRhYmxlKCd0cmlwcycpXG4gICAgICAgICAgLnNlbGVjdChbJ3BheW1lbnRfdHlwZSddKVxuICAgICAgICAgIC5jb3VudCgndHJpcF9pZCcsICd0cmlwX2NvdW50JylcbiAgICAgICAgICAuc3VtKCd0b3RhbF9hbW91bnQnLCAndG90YWxfcmV2ZW51ZScpXG4gICAgICAgICAgLmF2ZygndGlwX2Ftb3VudCcsICdhdmdfdGlwJylcbiAgICAgICAgICAuZ3JvdXBCeShbJ3BheW1lbnRfdHlwZSddKVxuICAgICAgICAgIC5vcmRlckJ5KCd0b3RhbF9yZXZlbnVlJywgJ0RFU0MnKVxuICAgICAgICAgIC5leGVjdXRlKCksXG4gICAgICApLFxuICB9KSxcbn0pO1xuXG5hcGkucm91dGUoJy9kYWlseVN0YXRzJywgYXBpLnF1ZXJpZXMuZGFpbHlTdGF0cywgeyBtZXRob2Q6ICdQT1NUJyB9KTtcbmFwaS5yb3V0ZSgnL3RvcFBpY2t1cExvY2F0aW9ucycsIGFwaS5xdWVyaWVzLnRvcFBpY2t1cExvY2F0aW9ucywgeyBtZXRob2Q6ICdQT1NUJyB9KTtcbmFwaS5yb3V0ZSgnL3JldmVudWVCeVBheW1lbnQnLCBhcGkucXVlcmllcy5yZXZlbnVlQnlQYXltZW50LCB7IG1ldGhvZDogJ0dFVCcgfSk7XG4iLCAiaW1wb3J0IHsgY3JlYXRlUXVlcnlCdWlsZGVyIH0gZnJvbSAnQGh5cGVxdWVyeS9jbGlja2hvdXNlJztcbmltcG9ydCB0eXBlIHsgSW50cm9zcGVjdGVkU2NoZW1hIH0gZnJvbSAnLi9zY2hlbWEnO1xuXG5jb25zdCBkYiA9IGNyZWF0ZVF1ZXJ5QnVpbGRlcjxJbnRyb3NwZWN0ZWRTY2hlbWE+KHtcbiAgdXJsOiBwcm9jZXNzLmVudi5DTElDS0hPVVNFX1VSTCA/PyBwcm9jZXNzLmVudi5DTElDS0hPVVNFX0hPU1QhLFxuICB1c2VybmFtZTogJ2RlZmF1bHQnLFxuICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuQ0xJQ0tIT1VTRV9QQVNTV09SRCEsXG4gIGRhdGFiYXNlOiBwcm9jZXNzLmVudi5DTElDS0hPVVNFX0RBVEFCQVNFISxcbn0pO1xuXG5leHBvcnQgeyBkYiB9O1xuZXhwb3J0IGRlZmF1bHQgZGI7XG4iXSwKICAibWFwcGluZ3MiOiAiO0FBQUEsU0FBUyxzQkFBc0I7QUFDL0IsU0FBUyxpQkFBaUI7QUFDMUIsU0FBUyxTQUFTOzs7QUNGbEIsU0FBUywwQkFBMEI7QUFHbkMsSUFBTSxLQUFLLG1CQUF1QztBQUFBLEVBQ2hELEtBQUssUUFBUSxJQUFJLGtCQUFrQixRQUFRLElBQUk7QUFBQSxFQUMvQyxVQUFVO0FBQUEsRUFDVixVQUFVLFFBQVEsSUFBSTtBQUFBLEVBQ3RCLFVBQVUsUUFBUSxJQUFJO0FBQ3hCLENBQUM7QUFHRCxJQUFPLGlCQUFROzs7QUROZixJQUFNLEVBQUUsUUFBUSxTQUFTLE1BQU0sSUFBSSxVQUFVO0FBQUEsRUFDM0MsU0FBUyxPQUFPLEVBQUUsbUJBQUc7QUFDdkIsQ0FBQztBQUVNLElBQU0sTUFBTSxPQUFPO0FBQUEsRUFDeEIsVUFBVTtBQUFBLEVBQ1YsU0FBUyxRQUFRO0FBQUEsSUFDZixZQUFZLE1BQ1QsU0FBUywrQkFBK0IsRUFDeEM7QUFBQSxNQUNDLEVBQUUsT0FBTztBQUFBLFFBQ1AsV0FBVyxFQUFFLE9BQU8sRUFBRSxTQUFTO0FBQUEsUUFDL0IsU0FBUyxFQUFFLE9BQU8sRUFBRSxTQUFTO0FBQUEsTUFDL0IsQ0FBQztBQUFBLElBQ0gsRUFDQztBQUFBLE1BQ0MsRUFBRTtBQUFBLFFBQ0EsRUFBRSxPQUFPO0FBQUEsVUFDUCxLQUFLLEVBQUUsT0FBTztBQUFBLFVBQ2QsWUFBWSxFQUFFLE9BQU87QUFBQSxVQUNyQixlQUFlLEVBQUUsT0FBTztBQUFBLFVBQ3hCLFVBQVUsRUFBRSxPQUFPO0FBQUEsVUFDbkIsY0FBYyxFQUFFLE9BQU87QUFBQSxRQUN6QixDQUFDO0FBQUEsTUFDSDtBQUFB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

//# sourceURL=file:///Users/lukereilly/repos/hypequery-examples/analytics/queries.ts