// analytics/queries.ts
import { formatDateTime } from "@hypequery/clickhouse";
import { initServe } from "@hypequery/serve";
import { z } from "zod";

// analytics/client.ts
import { createQueryBuilder } from "@hypequery/clickhouse";
console.log({
  url: process.env.CLICKHOUSE_HOST,
  username: process.env.CLICKHOUSE_USERNAME,
  password: process.env.CLICKHOUSE_PASSWORD,
  database: process.env.CLICKHOUSE_DATABASE
});
var db = createQueryBuilder({
  url: process.env.CLICKHOUSE_HOST,
  username: process.env.CLICKHOUSE_USERNAME,
  password: process.env.CLICKHOUSE_PASSWORD,
  database: process.env.CLICKHOUSE_DATABASE
});
var client_default = db;

// analytics/queries.ts
var { define, queries, query } = initServe({
  context: () => ({ db: client_default })
});
var api = define({
  basePath: "/api/analytics",
  queries: queries({
    dailyStats: query.describe("Daily trip counts and revenue").input(
      z.object({
        startDate: z.string().datetime(),
        endDate: z.string().datetime()
      })
    ).output(
      z.array(
        z.object({
          day: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_fare: z.number(),
          avg_distance: z.number()
        })
      )
    ).query(
      ({ ctx, input }) => {
        const res = ctx.db.table("trips").where("pickup_datetime", "gte", input.startDate).where("pickup_datetime", "lte", input.endDate).select([formatDateTime("pickup_datetime", "%Y-%m-%d", { alias: "day" })]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("fare_amount", "avg_fare").avg("trip_distance", "avg_distance").orderBy("day", "ASC").groupByTimeInterval("pickup_datetime", "1 day").toSQL();
        console.log(res);
      }
    ),
    topPickupLocations: query.describe("Top neighborhoods by trip volume").input(
      z.object({
        limit: z.number().min(1).max(50).default(10)
      })
    ).output(
      z.array(
        z.object({
          neighborhood: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_fare: z.number()
        })
      )
    ).query(({ ctx, input }) => {
      const limit = input.limit ?? 10;
      return ctx.db.table("trips").select(["pickup_ntaname AS neighborhood"]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("fare_amount", "avg_fare").groupBy(["neighborhood"]).orderBy("trip_count", "DESC").limit(limit).execute();
    }),
    revenueByPayment: query.describe("Revenue breakdown by payment method").output(
      z.array(
        z.object({
          payment_type: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_tip: z.number()
        })
      )
    ).query(
      ({ ctx }) => ctx.db.table("trips").select(["payment_type"]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("tip_amount", "avg_tip").groupBy(["payment_type"]).orderBy("total_revenue", "DESC").execute()
    )
  })
});
api.route("/dailyStats", api.queries.dailyStats, { method: "POST" });
api.route("/topPickupLocations", api.queries.topPickupLocations, { method: "POST" });
api.route("/revenueByPayment", api.queries.revenueByPayment, { method: "GET" });
export {
  api
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiYW5hbHl0aWNzL3F1ZXJpZXMudHMiLCAiYW5hbHl0aWNzL2NsaWVudC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgZm9ybWF0RGF0ZVRpbWUgfSBmcm9tICdAaHlwZXF1ZXJ5L2NsaWNraG91c2UnO1xuaW1wb3J0IHsgaW5pdFNlcnZlIH0gZnJvbSAnQGh5cGVxdWVyeS9zZXJ2ZSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCBkYiBmcm9tICcuL2NsaWVudCc7XG5cbmNvbnN0IHsgZGVmaW5lLCBxdWVyaWVzLCBxdWVyeSB9ID0gaW5pdFNlcnZlKHtcbiAgY29udGV4dDogKCkgPT4gKHsgZGIgfSksXG59KTtcblxuZXhwb3J0IGNvbnN0IGFwaSA9IGRlZmluZSh7XG4gIGJhc2VQYXRoOiAnL2FwaS9hbmFseXRpY3MnLFxuICBxdWVyaWVzOiBxdWVyaWVzKHtcbiAgICBkYWlseVN0YXRzOiBxdWVyeVxuICAgICAgLmRlc2NyaWJlKCdEYWlseSB0cmlwIGNvdW50cyBhbmQgcmV2ZW51ZScpXG4gICAgICAuaW5wdXQoXG4gICAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgICBzdGFydERhdGU6IHouc3RyaW5nKCkuZGF0ZXRpbWUoKSxcbiAgICAgICAgICBlbmREYXRlOiB6LnN0cmluZygpLmRhdGV0aW1lKCksXG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgICAgLm91dHB1dChcbiAgICAgICAgei5hcnJheShcbiAgICAgICAgICB6Lm9iamVjdCh7XG4gICAgICAgICAgICBkYXk6IHouc3RyaW5nKCksXG4gICAgICAgICAgICB0cmlwX2NvdW50OiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgdG90YWxfcmV2ZW51ZTogei5udW1iZXIoKSxcbiAgICAgICAgICAgIGF2Z19mYXJlOiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgYXZnX2Rpc3RhbmNlOiB6Lm51bWJlcigpLFxuICAgICAgICAgIH0pLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICAgLnF1ZXJ5KCh7IGN0eCwgaW5wdXQgfSkgPT4ge1xuICAgICAgICBjb25zdCByZXMgPSBjdHguZGJcbiAgICAgICAgICAudGFibGUoJ3RyaXBzJylcbiAgICAgICAgICAud2hlcmUoJ3BpY2t1cF9kYXRldGltZScsICdndGUnLCBpbnB1dC5zdGFydERhdGUpXG4gICAgICAgICAgLndoZXJlKCdwaWNrdXBfZGF0ZXRpbWUnLCAnbHRlJywgaW5wdXQuZW5kRGF0ZSlcbiAgICAgICAgICAuc2VsZWN0KFtmb3JtYXREYXRlVGltZSgncGlja3VwX2RhdGV0aW1lJywgJyVZLSVtLSVkJywgeyBhbGlhczogJ2RheScgfSldKVxuICAgICAgICAgIC5jb3VudCgndHJpcF9pZCcsICd0cmlwX2NvdW50JylcbiAgICAgICAgICAuc3VtKCd0b3RhbF9hbW91bnQnLCAndG90YWxfcmV2ZW51ZScpXG4gICAgICAgICAgLmF2ZygnZmFyZV9hbW91bnQnLCAnYXZnX2ZhcmUnKVxuICAgICAgICAgIC5hdmcoJ3RyaXBfZGlzdGFuY2UnLCAnYXZnX2Rpc3RhbmNlJylcbiAgICAgICAgICAub3JkZXJCeSgnZGF5JywgJ0FTQycpXG4gICAgICAgICAgLmdyb3VwQnlUaW1lSW50ZXJ2YWwoJ3BpY2t1cF9kYXRldGltZScsICcxIGRheScpXG4gICAgICAgICAgLnRvU1FMKClcblxuICAgICAgICBjb25zb2xlLmxvZyhyZXMpXG4gICAgICB9XG4gICAgICApLFxuXG4gICAgdG9wUGlja3VwTG9jYXRpb25zOiBxdWVyeVxuICAgICAgLmRlc2NyaWJlKCdUb3AgbmVpZ2hib3Job29kcyBieSB0cmlwIHZvbHVtZScpXG4gICAgICAuaW5wdXQoXG4gICAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgICBsaW1pdDogei5udW1iZXIoKS5taW4oMSkubWF4KDUwKS5kZWZhdWx0KDEwKSxcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICAub3V0cHV0KFxuICAgICAgICB6LmFycmF5KFxuICAgICAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgICAgIG5laWdoYm9yaG9vZDogei5zdHJpbmcoKSxcbiAgICAgICAgICAgIHRyaXBfY291bnQ6IHoubnVtYmVyKCksXG4gICAgICAgICAgICB0b3RhbF9yZXZlbnVlOiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgYXZnX2ZhcmU6IHoubnVtYmVyKCksXG4gICAgICAgICAgfSksXG4gICAgICAgICksXG4gICAgICApXG4gICAgICAucXVlcnkoKHsgY3R4LCBpbnB1dCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IGxpbWl0ID0gaW5wdXQubGltaXQgPz8gMTA7XG5cbiAgICAgICAgcmV0dXJuIGN0eC5kYlxuICAgICAgICAgIC50YWJsZSgndHJpcHMnKVxuICAgICAgICAgIC5zZWxlY3QoWydwaWNrdXBfbnRhbmFtZSBBUyBuZWlnaGJvcmhvb2QnXSlcbiAgICAgICAgICAuY291bnQoJ3RyaXBfaWQnLCAndHJpcF9jb3VudCcpXG4gICAgICAgICAgLnN1bSgndG90YWxfYW1vdW50JywgJ3RvdGFsX3JldmVudWUnKVxuICAgICAgICAgIC5hdmcoJ2ZhcmVfYW1vdW50JywgJ2F2Z19mYXJlJylcbiAgICAgICAgICAuZ3JvdXBCeShbJ25laWdoYm9yaG9vZCddKVxuICAgICAgICAgIC5vcmRlckJ5KCd0cmlwX2NvdW50JywgJ0RFU0MnKVxuICAgICAgICAgIC5saW1pdChsaW1pdClcbiAgICAgICAgICAuZXhlY3V0ZSgpO1xuICAgICAgfSksXG5cbiAgICByZXZlbnVlQnlQYXltZW50OiBxdWVyeVxuICAgICAgLmRlc2NyaWJlKCdSZXZlbnVlIGJyZWFrZG93biBieSBwYXltZW50IG1ldGhvZCcpXG4gICAgICAub3V0cHV0KFxuICAgICAgICB6LmFycmF5KFxuICAgICAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgICAgIHBheW1lbnRfdHlwZTogei5zdHJpbmcoKSxcbiAgICAgICAgICAgIHRyaXBfY291bnQ6IHoubnVtYmVyKCksXG4gICAgICAgICAgICB0b3RhbF9yZXZlbnVlOiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgYXZnX3RpcDogei5udW1iZXIoKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICAgIC5xdWVyeSgoeyBjdHggfSkgPT5cbiAgICAgICAgY3R4LmRiXG4gICAgICAgICAgLnRhYmxlKCd0cmlwcycpXG4gICAgICAgICAgLnNlbGVjdChbJ3BheW1lbnRfdHlwZSddKVxuICAgICAgICAgIC5jb3VudCgndHJpcF9pZCcsICd0cmlwX2NvdW50JylcbiAgICAgICAgICAuc3VtKCd0b3RhbF9hbW91bnQnLCAndG90YWxfcmV2ZW51ZScpXG4gICAgICAgICAgLmF2ZygndGlwX2Ftb3VudCcsICdhdmdfdGlwJylcbiAgICAgICAgICAuZ3JvdXBCeShbJ3BheW1lbnRfdHlwZSddKVxuICAgICAgICAgIC5vcmRlckJ5KCd0b3RhbF9yZXZlbnVlJywgJ0RFU0MnKVxuICAgICAgICAgIC5leGVjdXRlKCksXG4gICAgICApLFxuICB9KSxcbn0pO1xuXG5hcGkucm91dGUoJy9kYWlseVN0YXRzJywgYXBpLnF1ZXJpZXMuZGFpbHlTdGF0cywgeyBtZXRob2Q6ICdQT1NUJyB9KTtcbmFwaS5yb3V0ZSgnL3RvcFBpY2t1cExvY2F0aW9ucycsIGFwaS5xdWVyaWVzLnRvcFBpY2t1cExvY2F0aW9ucywgeyBtZXRob2Q6ICdQT1NUJyB9KTtcbmFwaS5yb3V0ZSgnL3JldmVudWVCeVBheW1lbnQnLCBhcGkucXVlcmllcy5yZXZlbnVlQnlQYXltZW50LCB7IG1ldGhvZDogJ0dFVCcgfSk7XG4iLCAiaW1wb3J0IHsgY3JlYXRlUXVlcnlCdWlsZGVyIH0gZnJvbSAnQGh5cGVxdWVyeS9jbGlja2hvdXNlJztcbmltcG9ydCB0eXBlIHsgSW50cm9zcGVjdGVkU2NoZW1hIH0gZnJvbSAnLi9zY2hlbWEnO1xuXG5jb25zb2xlLmxvZyh7XG4gIHVybDogcHJvY2Vzcy5lbnYuQ0xJQ0tIT1VTRV9IT1NUISxcbiAgdXNlcm5hbWU6IHByb2Nlc3MuZW52LkNMSUNLSE9VU0VfVVNFUk5BTUUsXG4gIHBhc3N3b3JkOiBwcm9jZXNzLmVudi5DTElDS0hPVVNFX1BBU1NXT1JELFxuICBkYXRhYmFzZTogcHJvY2Vzcy5lbnYuQ0xJQ0tIT1VTRV9EQVRBQkFTRSEsXG5cbn0pXG5jb25zdCBkYiA9IGNyZWF0ZVF1ZXJ5QnVpbGRlcjxJbnRyb3NwZWN0ZWRTY2hlbWE+KHtcbiAgdXJsOiBwcm9jZXNzLmVudi5DTElDS0hPVVNFX0hPU1QhLFxuICB1c2VybmFtZTogcHJvY2Vzcy5lbnYuQ0xJQ0tIT1VTRV9VU0VSTkFNRSxcbiAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LkNMSUNLSE9VU0VfUEFTU1dPUkQsXG4gIGRhdGFiYXNlOiBwcm9jZXNzLmVudi5DTElDS0hPVVNFX0RBVEFCQVNFISxcbn0pO1xuXG5leHBvcnQgeyBkYiB9O1xuZXhwb3J0IGRlZmF1bHQgZGI7XG4iXSwKICAibWFwcGluZ3MiOiAiO0FBQUEsU0FBUyxzQkFBc0I7QUFDL0IsU0FBUyxpQkFBaUI7QUFDMUIsU0FBUyxTQUFTOzs7QUNGbEIsU0FBUywwQkFBMEI7QUFHbkMsUUFBUSxJQUFJO0FBQUEsRUFDVixLQUFLLFFBQVEsSUFBSTtBQUFBLEVBQ2pCLFVBQVUsUUFBUSxJQUFJO0FBQUEsRUFDdEIsVUFBVSxRQUFRLElBQUk7QUFBQSxFQUN0QixVQUFVLFFBQVEsSUFBSTtBQUV4QixDQUFDO0FBQ0QsSUFBTSxLQUFLLG1CQUF1QztBQUFBLEVBQ2hELEtBQUssUUFBUSxJQUFJO0FBQUEsRUFDakIsVUFBVSxRQUFRLElBQUk7QUFBQSxFQUN0QixVQUFVLFFBQVEsSUFBSTtBQUFBLEVBQ3RCLFVBQVUsUUFBUSxJQUFJO0FBQ3hCLENBQUM7QUFHRCxJQUFPLGlCQUFROzs7QURiZixJQUFNLEVBQUUsUUFBUSxTQUFTLE1BQU0sSUFBSSxVQUFVO0FBQUEsRUFDM0MsU0FBUyxPQUFPLEVBQUUsbUJBQUc7QUFDdkIsQ0FBQztBQUVNLElBQU0sTUFBTSxPQUFPO0FBQUEsRUFDeEIsVUFBVTtBQUFBLEVBQ1YsU0FBUyxRQUFRO0FBQUEsSUFDZixZQUFZLE1BQ1QsU0FBUywrQkFBK0IsRUFDeEM7QUFBQSxNQUNDLEVBQUUsT0FBTztBQUFBLFFBQ1AsV0FBVyxFQUFFLE9BQU8sRUFBRSxTQUFTO0FBQUEsUUFDL0IsU0FBUyxFQUFFLE9BQU8sRUFBRSxTQUFTO0FBQUEsTUFDL0IsQ0FBQztBQUFBLElBQ0gsRUFDQztBQUFBLE1BQ0MsRUFBRTtBQUFBLFFBQ0EsRUFBRSxPQUFPO0FBQUEsVUFDUCxLQUFLLEVBQUUsT0FBTztBQUFBLFVBQ2QsWUFBWSxFQUFFLE9BQU87QUFBQSxVQUNyQixlQUFlLEVBQUUsT0FBTztBQUFBLFVBQ3hCLFVBQVUsRUFBRSxPQUFPO0FBQUEsVUFDbkIsY0FBYyxFQUFFLE9BQU87QUFBQSxRQUN6QixDQUFDO0FBQUEsTUFDSDtBQUFBLElBQ0YsRUFDQztBQUFBLE1BQU0sQ0FBQyxFQUFFLEtBQUssTUFBTSxNQUFNO0FBQ3pCLGNBQU0sTUFBTSxJQUFJLEdBQ2IsTUFBTSxPQUFPLEVBQ2IsTUFBTSxtQkFBbUIsT0FBTyxNQUFNLFNBQVMsRUFDL0MsTUFBTSxtQkFBbUIsT0FBTyxNQUFNLE9BQU8sRUFDN0MsT0FBTyxDQUFDLGVBQWUsbUJBQW1CLFlBQVksRUFBRSxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFDeEUsTUFBTSxXQUFXLFlBQVksRUFDN0IsSUFBSSxnQkFBZ0IsZUFBZSxFQUNuQyxJQUFJLGVBQWUsVUFBVSxFQUM3QixJQUFJLGlCQUFpQixjQUFjLEVBQ25DLFFBQVEsT0FBTyxLQUFLLEVBQ3BCLG9CQUFvQixtQkFBbUIsT0FBTyxFQUM5QyxNQUFNO0FBRVQsZ0JBQVEsSUFBSSxHQUFHO0FBQUEsTUFDakI7QUFBQSxJQUNBO0FBQUEsSUFFRixvQkFBb0IsTUFDakIsU0FBUyxrQ0FBa0MsRUFDM0M7QUFBQSxNQUNDLEVBQUUsT0FBTztBQUFBLFFBQ1AsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxRQUFRLEVBQUU7QUFBQSxNQUM3QyxDQUFDO0FBQUEsSUFDSCxFQUNDO0FBQUEsTUFDQyxFQUFFO0FBQUEsUUFDQSxFQUFFLE9BQU87QUFBQSxVQUNQLGNBQWMsRUFBRSxPQUFPO0FBQUEsVUFDdkIsWUFBWSxFQUFFLE9BQU87QUFBQSxVQUNyQixlQUFlLEVBQUUsT0FBTztBQUFBLFVBQ3hCLFVBQVUsRUFBRSxPQUFPO0FBQUEsUUFDckIsQ0FBQztBQUFBLE1BQ0g7QUFBQSxJQUNGLEVBQ0MsTUFBTSxDQUFDLEVBQUUsS0FBSyxNQUFNLE1BQU07QUFDekIsWUFBTSxRQUFRLE1BQU0sU0FBUztBQUU3QixhQUFPLElBQUksR0FDUixNQUFNLE9BQU8sRUFDYixPQUFPLENBQUMsZ0NBQWdDLENBQUMsRUFDekMsTUFBTSxXQUFXLFlBQVksRUFDN0IsSUFBSSxnQkFBZ0IsZUFBZSxFQUNuQyxJQUFJLGVBQWUsVUFBVSxFQUM3QixRQUFRLENBQUMsY0FBYyxDQUFDLEVBQ3hCLFFBQVEsY0FBYyxNQUFNLEVBQzVCLE1BQU0sS0FBSyxFQUNYLFFBQVE7QUFBQSxJQUNiLENBQUM7QUFBQSxJQUVILGtCQUFrQixNQUNmLFNBQVMscUNBQXFDLEVBQzlDO0FBQUEsTUFDQyxFQUFFO0FBQUEsUUFDQSxFQUFFLE9BQU87QUFBQSxVQUNQLGNBQWMsRUFBRSxPQUFPO0FBQUEsVUFDdkIsWUFBWSxFQUFFLE9BQU87QUFBQSxVQUNyQixlQUFlLEVBQUUsT0FBTztBQUFBLFVBQ3hCLFNBQVMsRUFBRSxPQUFPO0FBQUEsUUFDcEIsQ0FBQztBQUFBLE1BQ0g7QUFBQSxJQUNGLEVBQ0M7QUFBQSxNQUFNLENBQUMsRUFBRSxJQUFJLE1BQ1osSUFBSSxHQUNELE1BQU0sT0FBTyxFQUNiLE9BQU8sQ0FBQyxjQUFjLENBQUMsRUFDdkIsTUFBTSxXQUFXLFlBQVksRUFDN0IsSUFBSSxnQkFBZ0IsZUFBZSxFQUNuQyxJQUFJLGNBQWMsU0FBUyxFQUMzQixRQUFRLENBQUMsY0FBYyxDQUFDLEVBQ3hCLFFBQVEsaUJBQWlCLE1BQU0sRUFDL0IsUUFBUTtBQUFBLElBQ2I7QUFBQSxFQUNKLENBQUM7QUFDSCxDQUFDO0FBRUQsSUFBSSxNQUFNLGVBQWUsSUFBSSxRQUFRLFlBQVksRUFBRSxRQUFRLE9BQU8sQ0FBQztBQUNuRSxJQUFJLE1BQU0sdUJBQXVCLElBQUksUUFBUSxvQkFBb0IsRUFBRSxRQUFRLE9BQU8sQ0FBQztBQUNuRixJQUFJLE1BQU0scUJBQXFCLElBQUksUUFBUSxrQkFBa0IsRUFBRSxRQUFRLE1BQU0sQ0FBQzsiLAogICJuYW1lcyI6IFtdCn0K

//# sourceURL=file:///Users/lukereilly/repos/hypequery-examples/next-js/analytics/queries.ts