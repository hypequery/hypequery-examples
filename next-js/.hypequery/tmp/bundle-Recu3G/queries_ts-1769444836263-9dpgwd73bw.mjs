// analytics/queries.ts
import { formatDateTime } from "@hypequery/clickhouse";
import { initServe } from "@hypequery/serve";
import { z } from "zod";

// analytics/client.ts
import { createQueryBuilder } from "@hypequery/clickhouse";
var db = createQueryBuilder({
  url: process.env.CLICKHOUSE_URL,
  username: process.env.CLICKHOUSE_USERNAME,
  password: process.env.CLICKHOUSE_PASSWORD,
  database: process.env.CLICKHOUSE_DATABASE
});
var client_default = db;

// analytics/queries.ts
var { define, queries, query } = initServe({
  context: () => ({ db: client_default })
});
var api = define({
  queries: queries({
    dailyStats: query.describe("Daily trip counts and revenue").input(
      z.object({
        startDate: z.string().datetime(),
        endDate: z.string().datetime()
      })
    ).output(
      z.array(
        z.object({
          day: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_fare: z.number(),
          avg_distance: z.number()
        })
      )
    ).query(
      ({ ctx, input }) => ctx.db.table("trips").where("pickup_datetime", "gte", input.startDate).where("pickup_datetime", "lte", input.endDate).groupByTimeInterval("pickup_datetime", "1 day").select([formatDateTime("pickup_datetime", "%Y-%m-%d", { alias: "day" })]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("fare_amount", "avg_fare").avg("trip_distance", "avg_distance").orderBy("day", "ASC").execute()
    ),
    topPickupLocations: query.describe("Top neighborhoods by trip volume").input(
      z.object({
        limit: z.number().min(1).max(50).default(10)
      })
    ).output(
      z.array(
        z.object({
          neighborhood: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_fare: z.number()
        })
      )
    ).query(({ ctx, input }) => {
      const limit = input.limit ?? 10;
      return ctx.db.table("trips").select(["pickup_ntaname AS neighborhood"]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("fare_amount", "avg_fare").groupBy(["neighborhood"]).orderBy("trip_count", "DESC").limit(limit).execute();
    }),
    revenueByPayment: query.describe("Revenue breakdown by payment method").output(
      z.array(
        z.object({
          payment_type: z.string(),
          trip_count: z.number(),
          total_revenue: z.number(),
          avg_tip: z.number()
        })
      )
    ).query(
      ({ ctx }) => ctx.db.table("trips").select(["payment_type"]).count("trip_id", "trip_count").sum("total_amount", "total_revenue").avg("tip_amount", "avg_tip").groupBy(["payment_type"]).orderBy("total_revenue", "DESC").execute()
    )
  })
});
api.route("/dailyStats", api.queries.dailyStats, { method: "POST" });
api.route("/topPickupLocations", api.queries.topPickupLocations, { method: "POST" });
api.route("/revenueByPayment", api.queries.revenueByPayment, { method: "GET" });
export {
  api
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiYW5hbHl0aWNzL3F1ZXJpZXMudHMiLCAiYW5hbHl0aWNzL2NsaWVudC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgZm9ybWF0RGF0ZVRpbWUgfSBmcm9tICdAaHlwZXF1ZXJ5L2NsaWNraG91c2UnO1xuaW1wb3J0IHsgaW5pdFNlcnZlIH0gZnJvbSAnQGh5cGVxdWVyeS9zZXJ2ZSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCBkYiBmcm9tICcuL2NsaWVudCc7XG5cbmNvbnN0IHsgZGVmaW5lLCBxdWVyaWVzLCBxdWVyeSB9ID0gaW5pdFNlcnZlKHtcbiAgY29udGV4dDogKCkgPT4gKHsgZGIgfSksXG59KTtcblxuZXhwb3J0IGNvbnN0IGFwaSA9IGRlZmluZSh7XG4gIHF1ZXJpZXM6IHF1ZXJpZXMoe1xuICAgIGRhaWx5U3RhdHM6IHF1ZXJ5XG4gICAgICAuZGVzY3JpYmUoJ0RhaWx5IHRyaXAgY291bnRzIGFuZCByZXZlbnVlJylcbiAgICAgIC5pbnB1dChcbiAgICAgICAgei5vYmplY3Qoe1xuICAgICAgICAgIHN0YXJ0RGF0ZTogei5zdHJpbmcoKS5kYXRldGltZSgpLFxuICAgICAgICAgIGVuZERhdGU6IHouc3RyaW5nKCkuZGF0ZXRpbWUoKSxcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICAub3V0cHV0KFxuICAgICAgICB6LmFycmF5KFxuICAgICAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgICAgIGRheTogei5zdHJpbmcoKSxcbiAgICAgICAgICAgIHRyaXBfY291bnQ6IHoubnVtYmVyKCksXG4gICAgICAgICAgICB0b3RhbF9yZXZlbnVlOiB6Lm51bWJlcigpLFxuICAgICAgICAgICAgYXZnX2ZhcmU6IHoubnVtYmVyKCksXG4gICAgICAgICAgICBhdmdfZGlzdGFuY2U6IHoubnVtYmVyKCksXG4gICAgICAgICAgfSksXG4gICAgICAgICksXG4gICAgICApXG4gICAgICAucXVlcnkoKHsgY3R4LCBpbnB1dCB9KSA9PlxuICAgICAgICBjdHguZGJcbiAgICAgICAgICAudGFibGUoJ3RyaXBzJylcbiAgICAgICAgICAud2hlcmUoJ3BpY2t1cF9kYXRldGltZScsICdndGUnLCBpbnB1dC5zdGFydERhdGUpXG4gICAgICAgICAgLndoZXJlKCdwaWNrdXBfZGF0ZXRpbWUnLCAnbHRlJywgaW5wdXQuZW5kRGF0ZSlcbiAgICAgICAgICAuZ3JvdXBCeVRpbWVJbnRlcnZhbCgncGlja3VwX2RhdGV0aW1lJywgJzEgZGF5JylcbiAgICAgICAgICAuc2VsZWN0KFtmb3JtYXREYXRlVGltZSgncGlja3VwX2RhdGV0aW1lJywgJyVZLSVtLSVkJywgeyBhbGlhczogJ2RheScgfSldKVxuICAgICAgICAgIC5jb3VudCgndHJpcF9pZCcsICd0cmlwX2NvdW50JylcbiAgICAgICAgICAuc3VtKCd0b3RhbF9hbW91bnQnLCAndG90YWxfcmV2ZW51ZScpXG4gICAgICAgICAgLmF2ZygnZmFyZV9hbW91bnQnLCAnYXZnX2ZhcmUnKVxuICAgICAgICAgIC5hdmcoJ3RyaXBfZGlzdGFuY2UnLCAnYXZnX2Rpc3RhbmNlJylcbiAgICAgICAgICAub3JkZXJCeSgnZGF5JywgJ0FTQycpXG4gICAgICAgICAgLmV4ZWN1dGUoKSxcbiAgICAgICksXG5cbiAgICB0b3BQaWNrdXBMb2NhdGlvbnM6IHF1ZXJ5XG4gICAgICAuZGVzY3JpYmUoJ1RvcCBuZWlnaGJvcmhvb2RzIGJ5IHRyaXAgdm9sdW1lJylcbiAgICAgIC5pbnB1dChcbiAgICAgICAgei5vYmplY3Qoe1xuICAgICAgICAgIGxpbWl0OiB6Lm51bWJlcigpLm1pbigxKS5tYXgoNTApLmRlZmF1bHQoMTApLFxuICAgICAgICB9KSxcbiAgICAgIClcbiAgICAgIC5vdXRwdXQoXG4gICAgICAgIHouYXJyYXkoXG4gICAgICAgICAgei5vYmplY3Qoe1xuICAgICAgICAgICAgbmVpZ2hib3Job29kOiB6LnN0cmluZygpLFxuICAgICAgICAgICAgdHJpcF9jb3VudDogei5udW1iZXIoKSxcbiAgICAgICAgICAgIHRvdGFsX3JldmVudWU6IHoubnVtYmVyKCksXG4gICAgICAgICAgICBhdmdfZmFyZTogei5udW1iZXIoKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICAgIC5xdWVyeSgoeyBjdHgsIGlucHV0IH0pID0+IHtcbiAgICAgICAgY29uc3QgbGltaXQgPSBpbnB1dC5saW1pdCA/PyAxMDtcblxuICAgICAgICByZXR1cm4gY3R4LmRiXG4gICAgICAgICAgLnRhYmxlKCd0cmlwcycpXG4gICAgICAgICAgLnNlbGVjdChbJ3BpY2t1cF9udGFuYW1lIEFTIG5laWdoYm9yaG9vZCddKVxuICAgICAgICAgIC5jb3VudCgndHJpcF9pZCcsICd0cmlwX2NvdW50JylcbiAgICAgICAgICAuc3VtKCd0b3RhbF9hbW91bnQnLCAndG90YWxfcmV2ZW51ZScpXG4gICAgICAgICAgLmF2ZygnZmFyZV9hbW91bnQnLCAnYXZnX2ZhcmUnKVxuICAgICAgICAgIC5ncm91cEJ5KFsnbmVpZ2hib3Job29kJ10pXG4gICAgICAgICAgLm9yZGVyQnkoJ3RyaXBfY291bnQnLCAnREVTQycpXG4gICAgICAgICAgLmxpbWl0KGxpbWl0KVxuICAgICAgICAgIC5leGVjdXRlKCk7XG4gICAgICB9KSxcblxuICAgIHJldmVudWVCeVBheW1lbnQ6IHF1ZXJ5XG4gICAgICAuZGVzY3JpYmUoJ1JldmVudWUgYnJlYWtkb3duIGJ5IHBheW1lbnQgbWV0aG9kJylcbiAgICAgIC5vdXRwdXQoXG4gICAgICAgIHouYXJyYXkoXG4gICAgICAgICAgei5vYmplY3Qoe1xuICAgICAgICAgICAgcGF5bWVudF90eXBlOiB6LnN0cmluZygpLFxuICAgICAgICAgICAgdHJpcF9jb3VudDogei5udW1iZXIoKSxcbiAgICAgICAgICAgIHRvdGFsX3JldmVudWU6IHoubnVtYmVyKCksXG4gICAgICAgICAgICBhdmdfdGlwOiB6Lm51bWJlcigpLFxuICAgICAgICAgIH0pLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICAgLnF1ZXJ5KCh7IGN0eCB9KSA9PlxuICAgICAgICBjdHguZGJcbiAgICAgICAgICAudGFibGUoJ3RyaXBzJylcbiAgICAgICAgICAuc2VsZWN0KFsncGF5bWVudF90eXBlJ10pXG4gICAgICAgICAgLmNvdW50KCd0cmlwX2lkJywgJ3RyaXBfY291bnQnKVxuICAgICAgICAgIC5zdW0oJ3RvdGFsX2Ftb3VudCcsICd0b3RhbF9yZXZlbnVlJylcbiAgICAgICAgICAuYXZnKCd0aXBfYW1vdW50JywgJ2F2Z190aXAnKVxuICAgICAgICAgIC5ncm91cEJ5KFsncGF5bWVudF90eXBlJ10pXG4gICAgICAgICAgLm9yZGVyQnkoJ3RvdGFsX3JldmVudWUnLCAnREVTQycpXG4gICAgICAgICAgLmV4ZWN1dGUoKSxcbiAgICAgICksXG4gIH0pLFxufSk7XG5cbmFwaS5yb3V0ZSgnL2RhaWx5U3RhdHMnLCBhcGkucXVlcmllcy5kYWlseVN0YXRzLCB7IG1ldGhvZDogJ1BPU1QnIH0pO1xuYXBpLnJvdXRlKCcvdG9wUGlja3VwTG9jYXRpb25zJywgYXBpLnF1ZXJpZXMudG9wUGlja3VwTG9jYXRpb25zLCB7IG1ldGhvZDogJ1BPU1QnIH0pO1xuYXBpLnJvdXRlKCcvcmV2ZW51ZUJ5UGF5bWVudCcsIGFwaS5xdWVyaWVzLnJldmVudWVCeVBheW1lbnQsIHsgbWV0aG9kOiAnR0VUJyB9KTtcbiIsICJpbXBvcnQgeyBjcmVhdGVRdWVyeUJ1aWxkZXIgfSBmcm9tICdAaHlwZXF1ZXJ5L2NsaWNraG91c2UnO1xuaW1wb3J0IHR5cGUgeyBJbnRyb3NwZWN0ZWRTY2hlbWEgfSBmcm9tICcuL3NjaGVtYSc7XG5cbmNvbnN0IGRiID0gY3JlYXRlUXVlcnlCdWlsZGVyPEludHJvc3BlY3RlZFNjaGVtYT4oe1xuICB1cmw6IHByb2Nlc3MuZW52LkNMSUNLSE9VU0VfVVJMLFxuICB1c2VybmFtZTogcHJvY2Vzcy5lbnYuQ0xJQ0tIT1VTRV9VU0VSTkFNRSxcbiAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LkNMSUNLSE9VU0VfUEFTU1dPUkQhLFxuICBkYXRhYmFzZTogcHJvY2Vzcy5lbnYuQ0xJQ0tIT1VTRV9EQVRBQkFTRSEsXG59KTtcblxuZXhwb3J0IHsgZGIgfTtcbmV4cG9ydCBkZWZhdWx0IGRiO1xuIl0sCiAgIm1hcHBpbmdzIjogIjtBQUFBLFNBQVMsc0JBQXNCO0FBQy9CLFNBQVMsaUJBQWlCO0FBQzFCLFNBQVMsU0FBUzs7O0FDRmxCLFNBQVMsMEJBQTBCO0FBR25DLElBQU0sS0FBSyxtQkFBdUM7QUFBQSxFQUNoRCxLQUFLLFFBQVEsSUFBSTtBQUFBLEVBQ2pCLFVBQVUsUUFBUSxJQUFJO0FBQUEsRUFDdEIsVUFBVSxRQUFRLElBQUk7QUFBQSxFQUN0QixVQUFVLFFBQVEsSUFBSTtBQUN4QixDQUFDO0FBR0QsSUFBTyxpQkFBUTs7O0FETmYsSUFBTSxFQUFFLFFBQVEsU0FBUyxNQUFNLElBQUksVUFBVTtBQUFBLEVBQzNDLFNBQVMsT0FBTyxFQUFFLG1CQUFHO0FBQ3ZCLENBQUM7QUFFTSxJQUFNLE1BQU0sT0FBTztBQUFBLEVBQ3hCLFNBQVMsUUFBUTtBQUFBLElBQ2YsWUFBWSxNQUNULFNBQVMsK0JBQStCLEVBQ3hDO0FBQUEsTUFDQyxFQUFFLE9BQU87QUFBQSxRQUNQLFdBQVcsRUFBRSxPQUFPLEVBQUUsU0FBUztBQUFBLFFBQy9CLFNBQVMsRUFBRSxPQUFPLEVBQUUsU0FBUztBQUFBLE1BQy9CLENBQUM7QUFBQSxJQUNILEVBQ0M7QUFBQSxNQUNDLEVBQUU7QUFBQSxRQUNBLEVBQUUsT0FBTztBQUFBLFVBQ1AsS0FBSyxFQUFFLE9BQU87QUFBQSxVQUNkLFlBQVksRUFBRSxPQUFPO0FBQUEsVUFDckIsZUFBZSxFQUFFLE9BQU87QUFBQSxVQUN4QixVQUFVLEVBQUUsT0FBTztBQUFBLFVBQ25CLGNBQWMsRUFBRSxPQUFPO0FBQUEsUUFDekIsQ0FBQztBQUFBLE1BQ0g7QUFBQSxJQUNGLEVBQ0M7QUFBQSxNQUFNLENBQUMsRUFBRSxLQUFLLE1BQU0sTUFDbkIsSUFBSSxHQUNELE1BQU0s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

//# sourceURL=file:///Users/lukereilly/repos/hypequery-examples/analytics/queries.ts